- name: Deploy to VPS
  uses: appleboy/ssh-action@v1.0.3
  with:
    host: ${{ secrets.VPS_HOST }}
    username: ${{ secrets.VPS_USER }}
    key: ${{ secrets.VPS_SSH_KEY }}
    script: |
      # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
      cd /var/www/currency-exchange/CriptoBotTG
      
      echo "‚¨áÔ∏è –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ Git..."
      git fetch origin
      git reset --hard origin/main
      
      echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å package.json..."
      cd backend
      if ! node -e "JSON.parse(require('fs').readFileSync('package.json', 'utf8'))" 2>/dev/null; then
        echo "‚ùå –û—à–∏–±–∫–∞ –≤ backend/package.json! –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º..."
        git checkout HEAD -- package.json
      fi
      
      echo "üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –±–µ–∫–µ–Ω–¥..."
      npm install --production
      pm2 restart currency-backend || pm2 start proxy.js --name "currency-backend"
      
      # --- –§—Ä–æ–Ω—Ç–µ–Ω–¥ ---
      cd ../frontend
      echo "üîÑ –°–æ–±–∏—Ä–∞–µ–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥..."
      npm ci
      npm run build
      
      # üî• –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –≤ public/
      echo "üìÅ –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞..."
      # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –ø–∞–ø–∫–∞ public —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
      mkdir -p ../public
      # –ö–æ–ø–∏—Ä—É–µ–º –í–°–Å –∏–∑ dist –≤ public (—Å —É–¥–∞–ª–µ–Ω–∏–µ–º —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤)
      rm -rf ../public/*
      cp -r dist/* ../public/
      
      # --- Telegram –±–æ—Ç –Ω–∞ Telegraf ---
      cd ../telegram-bot-telegraf
      echo "ü§ñ –û–±–Ω–æ–≤–ª—è–µ–º Telegram –±–æ—Ç–∞..."
      
      # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ñ–∞–π–ª—ã –±–æ—Ç–∞
      if [ -f "package.json" ]; then
        echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –±–æ—Ç–∞..."
        npm install --production
        
        if pm2 list | grep -q "vertex-bot-telegraf"; then
          pm2 restart vertex-bot-telegraf
        else
          if [ ! -f ".env" ]; then
            echo "‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: .env –Ω–µ –Ω–∞–π–¥–µ–Ω. –ë–æ—Ç –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –±–µ–∑ —Ç–æ–∫–µ–Ω–∞!"
          fi
          pm2 start bot.js --name "vertex-bot-telegraf"
          pm2 save
        fi
      else
        echo "‚ö†Ô∏è –ü–∞–ø–∫–∞ –±–æ—Ç–∞ –ø—É—Å—Ç–∞ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç package.json. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º."
      fi
      
      echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"